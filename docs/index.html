<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Macro Dashboard (Oro)</title>

  <!-- Sube v= cuando cambies CSS para evitar cachÃ© -->
  <link rel="stylesheet" href="./style.css?v=9">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body>

  <!-- TOPBAR FIJA -->
  <div class="topbar">
    <div class="left">
      <div style="font-weight:800;">ðŸ“¡ Macro Dashboard</div>
      <div id="updated" style="opacity:.8;"></div>
    </div>

    <div class="right">
      <button id="btnRefresh" class="btn" type="button" title="Refrescar ahora">
        ðŸ”„ Refrescar
      </button>

      <div class="card" style="margin:0; padding:8px 10px;">
        Score: <span id="score"></span> |
        Bias: <span id="bias" class="badge mix"></span> |
        Oro: <span id="gold"></span>
      </div>
    </div>
  </div>

  <!-- WIDGETS LIVE (4 velas en fila) -->
  <div class="live-row-wrap" id="liveRow">

    <div class="live-card" data-asset="gold">
      <div class="live-header">
        <div class="live-title">GOLD Â· <span class="tf">--</span></div>
        <div class="live-clock">
          <span class="now">--:--:--</span>
          <span class="sep">Â·</span>
          <span class="left">--:--</span>
        </div>
      </div>

      <div class="live-body">
        <div class="thermo">
          <div class="wick"></div>
          <div class="candle"></div>
          <div class="marker"></div>
          <div class="c-progress"></div>
          <div class="price-float">--</div>
        </div>
        <div class="live-stats"></div>
      </div>
    </div>

    <div class="live-card" data-asset="dxy">
      <div class="live-header">
        <div class="live-title">DXY Â· <span class="tf">--</span></div>
        <div class="live-clock">
          <span class="now">--:--:--</span>
          <span class="sep">Â·</span>
          <span class="left">--:--</span>
        </div>
      </div>

      <div class="live-body">
        <div class="thermo">
          <div class="wick"></div>
          <div class="candle"></div>
          <div class="marker"></div>
          <div class="price-float">--</div>
        </div>
        <div class="live-stats"></div>
      </div>
    </div>

    <div class="live-card" data-asset="tnx">
      <div class="live-header">
        <div class="live-title">TNX Â· <span class="tf">--</span></div>
        <div class="live-clock">
          <span class="now">--:--:--</span>
          <span class="sep">Â·</span>
          <span class="left">--:--</span>
        </div>
      </div>

      <div class="live-body">
        <div class="thermo">
          <div class="wick"></div>
          <div class="candle"></div>
          <div class="marker"></div>
          <div class="price-float">--</div>
        </div>
        <div class="live-stats"></div>
      </div>
    </div>

    <div class="live-card" data-asset="nasdaq">
      <div class="live-header">
        <div class="live-title">NASDAQ Â· <span class="tf">--</span></div>
        <div class="live-clock">
          <span class="now">--:--:--</span>
          <span class="sep">Â·</span>
          <span class="left">--:--</span>
        </div>
      </div>

      <div class="live-body">
        <div class="thermo">
          <div class="wick"></div>
          <div class="candle"></div>
          <div class="marker"></div>
          <div class="price-float">--</div>
        </div>
        <div class="live-stats"></div>
      </div>
    </div>

  </div>

  <!-- CONTENIDO (SCROLL INTERNO) -->
  <div class="main">

    <!-- PANEL DE SEÃ‘ALES -->
    <div id="signalsPanel" class="card">
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;">
        <div>
          <div style="font-weight:700;">SeÃ±ales</div>
          <div id="lastSignalText" style="opacity:.9;">(cargando...)</div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <a class="btn" href="https://www.etoro.com/" target="_blank"
             style="background:#1db954; color:#0b0f14; font-weight:800; text-decoration:none;">
            Abrir eToro
          </a>

          <a class="btn" href="https://www.binance.com/" target="_blank"
             style="background:#f0b90b; color:#0b0f14; font-weight:800; text-decoration:none;">
            Abrir Binance
          </a>
        </div>
      </div>

      <div id="signalsList" style="margin-top:10px; display:grid; gap:8px;"></div>
    </div>

    <!-- GRÃFICOS -->
    <div class="grid">
      <div class="chart-card">
        <div class="chart-wrap">
          <canvas id="goldChart"></canvas>
        </div>
      </div>

      <div class="chart-card">
        <div class="chart-wrap">
          <canvas id="scoreChart"></canvas>
        </div>
      </div>
    </div>

  </div>

<script>
/* =========================
   ESTADO GLOBAL
   ========================= */
let goldChartInstance = null;
let scoreChartInstance = null;

let clockTimer = null;
let liveTicker = null;
let lastDataCache = null;

/* =========================
   HELPERS
   ========================= */
function fmt(n, d=2){
  if (n === undefined || n === null || Number.isNaN(n)) return "â€”";
  return Number(n).toFixed(d);
}
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

function tfToMinutes(tf){
  if (!tf || typeof tf !== "string") return 60;
  const s = tf.trim().toLowerCase();
  if (s.endsWith("m")) return parseInt(s,10) || 60;
  if (s.endsWith("h")) return (parseInt(s,10) || 1) * 60;
  if (s.endsWith("d")) return (parseInt(s,10) || 1) * 1440;
  return 60;
}

/* vela actual (inicio) */
function candleStartMs(last, tfMin){
  if (last?.candle_ts){
    const ms = new Date(last.candle_ts).getTime();
    if (!Number.isNaN(ms)) return ms;
  }
  const now = Date.now();
  const block = tfMin * 60 * 1000;
  return Math.floor(now / block) * block;
}

function updateTimeLeftUI(tfMin, startMs){
  const endMs = startMs + tfMin*60*1000;
  const leftMs = Math.max(0, endMs - Date.now());
  const leftMin = Math.floor(leftMs / 60000);
  const leftSec = Math.floor((leftMs % 60000) / 1000);
  const mm = String(leftMin).padStart(2,"0");
  const ss = String(leftSec).padStart(2,"0");
  document.querySelectorAll(".live-card .left").forEach(el => el.textContent = `-${mm}:${ss}`);
}

function startClockAll(){
  if (clockTimer) clearInterval(clockTimer);

  const tick = () => {
    const t = new Date().toLocaleTimeString("es-ES", {
      timeZone: "Europe/Madrid",
      hour12: false
    });
    document.querySelectorAll(".live-card .now").forEach(el => el.textContent = t);
  };

  tick();
  clockTimer = setInterval(tick, 1000);
}

/* open de la vela */
function findOpen(series, last, key, startMs){
  if (last?.candle_ts){
    const row = series.find(x => x.candle_ts === last.candle_ts);
    if (row && row[key] != null) return row[key];
  }

  const row2 = series.find(x => {
    const ms = new Date(x.ts).getTime();
    return !Number.isNaN(ms) && ms >= startMs;
  });
  if (row2 && row2[key] != null) return row2[key];

  return series[0]?.[key] ?? last?.[key];
}

/* =========================
   LIVE WIDGETS
   ========================= */
function updateLiveRowFromCache(){
  if (!lastDataCache) return;

  const data = lastDataCache;
  const series = data.series || [];
  if (!series.length) return;

  const last = series[series.length - 1];

  const tf = data?.meta?.timeframe || "60m";
  const tfMin = tfToMinutes(tf);
  const startMs = candleStartMs(last, tfMin);
  const endMs = startMs + tfMin*60*1000;
  const prog = clamp((Date.now() - startMs) / (endMs - startMs), 0, 1);

  document.querySelectorAll(".live-card .tf").forEach(el => el.textContent = tf);
  updateTimeLeftUI(tfMin, startMs);

  const map = {
    gold:   { key:"gold",   atrKey:"atr",  decimals:1 },
    dxy:    { key:"dxy",    atrKey:null,   decimals:3 },
    tnx:    { key:"tnx",    atrKey:null,   decimals:3 },
    nasdaq: { key:"nasdaq", atrKey:null,   decimals:1 },
  };

  document.querySelectorAll(".live-card").forEach(card => {
    const asset = card.dataset.asset;
    const cfg = map[asset];
    if (!cfg) return;

    const price = last?.[cfg.key];
    if (price == null) return;

    let open = findOpen(series, last, cfg.key, startMs);
    const prev = series.length >= 2 ? series[series.length - 2] : null;
    if (prev && (open == null || Math.abs(price - open) < 1e-12)) {
      open = prev[cfg.key];
    }
    const delta = price - open;

    let scale = 1;
    if (cfg.atrKey && last?.[cfg.atrKey] != null) {
      scale = Math.max(Number(last[cfg.atrKey]) || 25, 0.00001);
    } else {
      const tail = series.slice(-20)
        .map(x => Number(x?.[cfg.key]))
        .filter(n => Number.isFinite(n));
      const minV = tail.length ? Math.min(...tail) : price;
      const maxV = tail.length ? Math.max(...tail) : price;
      const range = Math.max(maxV - minV, Math.abs(price) * 0.001);
      scale = Math.max(range, 0.00001);
    }

    const pos = clamp(0.5 + (delta / (2 * scale)), 0, 1);

    const thermo = card.querySelector(".thermo");
    const candle = card.querySelector(".candle");
    const marker = card.querySelector(".marker");
    const floatP = card.querySelector(".price-float");
    const stats  = card.querySelector(".live-stats");
    const progBar = card.querySelector(".c-progress"); // solo en GOLD

    if (!thermo || !candle || !marker || !floatP || !stats) return;

    // lÃ­nea de nivel para thermo::after
    thermo.style.setProperty("--lvl", `${pos * 100}%`);

    candle.style.height = `${clamp(pos*100, 6, 100)}%`;
    marker.style.bottom = `${pos*100}%`;
    floatP.style.bottom = `${pos*100}%`;
    floatP.textContent = fmt(price, cfg.decimals);

    candle.classList.remove("c-up","c-down");
    candle.classList.add(delta >= 0 ? "c-up" : "c-down");

    if (progBar){
      progBar.style.height = `${prog * 100}%`;
    }

    stats.innerHTML = `
      <div class="live-row"><span class="k">Open</span><span class="v">${fmt(open, cfg.decimals)}</span></div>
      <div class="live-row"><span class="k">Last</span><span class="v">${fmt(price, cfg.decimals)}</span></div>
      <div class="live-row"><span class="k">Î”</span><span class="v">${delta>=0?"+":""}${fmt(delta, cfg.decimals)}</span></div>
      <div class="live-row"><span class="k">Progreso</span><span class="v">${Math.round(prog*100)}%</span></div>
    `;
  });
}

function startLiveTicker(){
  if (liveTicker) clearInterval(liveTicker);
  liveTicker = setInterval(updateLiveRowFromCache, 1000);
}

/* =========================
   RENDER PRINCIPAL
   ========================= */
async function loadData() {
  // console.log("loadData()", new Date().toLocaleTimeString()); // DEBUG opcional

  const res = await fetch(`./macro_data.json?ts=${Date.now()}`, { cache: "no-store" });
  const data = await res.json();
  const series = data.series || [];

  if (!series.length) {
    document.getElementById("updated").innerText = "Sin datos aÃºnâ€¦";
    return;
  }

  lastDataCache = data;
  const last = series[series.length - 1];

  document.getElementById("updated").innerText =
    "Actualizado: " + new Date(data.meta.updated_utc)
      .toLocaleString("es-ES", { timeZone: "Europe/Madrid" });

  document.getElementById("score").innerText = last.score + "/100";

  let biasText = "ðŸŸ¡ Mixto";
  let cls = "mix";
  if (last.bias === "LONG_FAVORABLE") { biasText = "ðŸŸ¢ LONG"; cls = "long"; }
  if (last.bias === "SHORT_CUIDADO") { biasText = "ðŸ”´ SHORT"; cls = "short"; }

  const biasEl = document.getElementById("bias");
  biasEl.innerText = biasText;
  biasEl.className = "badge " + cls;

  document.getElementById("gold").innerText = last.gold;

  updateLiveRowFromCache();

  // SEÃ‘ALES
  const signals = (data.signals || []).slice(-10).reverse();
  const lastSignalText = document.getElementById("lastSignalText");
  const signalsList = document.getElementById("signalsList");

  function iconFor(t) {
    if (t === "BUY") return "ðŸŸ¢â¬†ï¸";
    if (t === "SELL") return "ðŸ”´â¬‡ï¸";
    if (t === "STOP_HIT") return "ðŸŸ ðŸ›‘";
    if (t === "CONFIRM_UP") return "ðŸŸ¦âœ…";
    return "ðŸŸ ðŸš¨";
  }

  if (!signals.length) {
    lastSignalText.textContent = "Sin seÃ±ales.";
    signalsList.innerHTML = "";
  } else {
    const lastSig = signals[0];
    lastSignalText.textContent =
      `${iconFor(lastSig.type)} ${lastSig.asset} â€” ${lastSig.type} â€” ${lastSig.reason}`;

    signalsList.innerHTML = signals.map(s => `
      <div class="card" style="padding:10px;">
        <div style="font-weight:700;">
          ${iconFor(s.type)} ${s.asset} â€” ${s.type} (fuerza ${s.strength})
        </div>
        <div style="opacity:.85">${s.reason}</div>
        <div style="opacity:.6; font-size:12px">${new Date(s.ts).toLocaleString("es-ES")}</div>
      </div>
    `).join("");
  }

  // GRÃFICOS
  const labels = series.map(x =>
    new Date(x.ts).toLocaleString("es-ES", { timeZone: "Europe/Madrid" })
  );

  if (goldChartInstance) goldChartInstance.destroy();
  if (scoreChartInstance) scoreChartInstance.destroy();

  goldChartInstance = new Chart(document.getElementById("goldChart"), {
    type: "line",
    data: {
      labels,
      datasets: [
        { label: "Gold", data: series.map(x => x.gold) },
        { label: "EMA21", data: series.map(x => x.gold_ema21) },
        { label: "EMA50", data: series.map(x => x.gold_ema50) }
      ]
    },
    options: { responsive: true, maintainAspectRatio: false }
  });

  scoreChartInstance = new Chart(document.getElementById("scoreChart"), {
    type: "line",
    data: { labels, datasets: [{ label: "Score", data: series.map(x => x.score) }] },
    options: { responsive: true, maintainAspectRatio: false }
  });
}

/* =========================
   BOTÃ“N REFRESCAR
   ========================= */
function hookRefreshButton(){
  window.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("btnRefresh");
    if (!btn) return;

    btn.addEventListener("click", async () => {
      try{
        btn.disabled = true;
        btn.classList.add("is-loading");
        await loadData();
        updateLiveRowFromCache();
      }catch(e){
        console.error(e);
      }finally{
        btn.classList.remove("is-loading");
        btn.disabled = false;
      }
    });
  });
}

/* =========================
   ARRANQUE
   ========================= */
startClockAll();
startLiveTicker();
hookRefreshButton();
loadData();
setInterval(loadData, 30000);
</script>

</body>
</html>
