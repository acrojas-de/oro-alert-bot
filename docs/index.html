<!doctype html>
<html lang="es">
<head>
  <link rel="stylesheet" href="./style.css">
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Macro Dashboard (Oro)</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

</head>

<body>

  <!-- TOPBAR FIJA -->
  <div class="topbar">
    <div class="left">
      <div style="font-weight:800;">ðŸ“¡ Macro Dashboard</div>
      <div id="updated" style="opacity:.8;"></div>
    </div>

    <div class="right">
      <div class="card" style="margin:0; padding:8px 10px;">
        Score: <span id="score"></span> |
        Bias: <span id="bias" class="badge mix"></span> |
        Oro: <span id="gold"></span>
      </div>
    </div>
  </div>

  <!-- WIDGET VELA-TERMÃ“METRO + RELOJ -->
  <!-- WIDGETS LIVE (4 velas en fila) -->
<div class="live-row-wrap" id="liveRow">
  <div class="live-card" data-asset="gold" data-label="GOLD">
    <div class="live-header">
      <div class="live-title">GOLD Â· <span class="tf">--</span></div>
      <div class="live-clock">
        <span class="now">--:--:--</span>
        <span class="sep">Â·</span>
        <span class="left">--:--</span>
      </div>
    </div>

    <div class="live-body">
      <div class="thermo">
        <div class="wick"></div>
        <div class="candle"></div>
        <div class="marker"></div>
        <div class="price-float">--</div>
      </div>

      <div class="live-stats"></div>
    </div>
  </div>

  <div class="live-card" data-asset="dxy" data-label="DXY">
    <div class="live-header">
      <div class="live-title">DXY Â· <span class="tf">--</span></div>
      <div class="live-clock">
        <span class="now">--:--:--</span>
        <span class="sep">Â·</span>
        <span class="left">--:--</span>
      </div>
    </div>

    <div class="live-body">
      <div class="thermo">
        <div class="wick"></div>
        <div class="candle"></div>
        <div class="marker"></div>
        <div class="price-float">--</div>
      </div>

      <div class="live-stats"></div>
    </div>
  </div>

  <div class="live-card" data-asset="tnx" data-label="TNX">
    <div class="live-header">
      <div class="live-title">TNX Â· <span class="tf">--</span></div>
      <div class="live-clock">
        <span class="now">--:--:--</span>
        <span class="sep">Â·</span>
        <span class="left">--:--</span>
      </div>
    </div>

    <div class="live-body">
      <div class="thermo">
        <div class="wick"></div>
        <div class="candle"></div>
        <div class="marker"></div>
        <div class="price-float">--</div>
      </div>

      <div class="live-stats"></div>
    </div>
  </div>

  <div class="live-card" data-asset="nasdaq" data-label="NASDAQ">
    <div class="live-header">
      <div class="live-title">NASDAQ Â· <span class="tf">--</span></div>
      <div class="live-clock">
        <span class="now">--:--:--</span>
        <span class="sep">Â·</span>
        <span class="left">--:--</span>
      </div>
    </div>

    <div class="live-body">
      <div class="thermo">
        <div class="wick"></div>
        <div class="candle"></div>
        <div class="marker"></div>
        <div class="price-float">--</div>
      </div>

      <div class="live-stats"></div>
    </div>
  </div>
</div>

  <!-- CONTENIDO (SCROLL INTERNO) -->
  <div class="main">

    <!-- âœ… PANEL DE SEÃ‘ALES -->
    <div id="signalsPanel" class="card">
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;">
        <div>
          <div style="font-weight:700;">SeÃ±ales</div>
          <div id="lastSignalText" style="opacity:.9;">(cargando...)</div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <a class="btn" href="https://www.etoro.com/" target="_blank"
             style="background:#1db954; color:#0b0f14; font-weight:800; text-decoration:none;">
            Abrir eToro
          </a>

          <a class="btn" href="https://www.binance.com/" target="_blank"
             style="background:#f0b90b; color:#0b0f14; font-weight:800; text-decoration:none;">
            Abrir Binance
          </a>
        </div>
      </div>

      <div id="signalsList" style="margin-top:10px; display:grid; gap:8px;"></div>
    </div>

    <!-- GRÃFICOS -->
    <div class="grid">
      <div class="chart-card">
        <div class="chart-wrap">
          <canvas id="goldChart"></canvas>
        </div>
      </div>

      <div class="chart-card">
        <div class="chart-wrap">
          <canvas id="scoreChart"></canvas>
        </div>
      </div>
    </div>

  </div> <!-- /main -->

  <script>
let goldChartInstance = null;
let scoreChartInstance = null;

let clockTimer = null;

// ======= helpers =======
function fmt(n, d=2){
  if (n === undefined || n === null || Number.isNaN(n)) return "â€”";
  return Number(n).toFixed(d);
}
function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

// Reloj digital (independiente del fetch)
function startClock(){
  const el = document.getElementById("liveClock");
  if (!el) return;

  if (clockTimer) clearInterval(clockTimer);

  const tick = () => {
    const now = new Date();
    el.textContent = now.toLocaleTimeString("es-ES", {
      timeZone: "Europe/Madrid",
      hour12: false
    });
  };

  tick();
  clockTimer = setInterval(tick, 1000);
}

// Encuentra el "open" de la vela actual usando candle_ts
function getCandleOpen(series, last){
  // Si el backend ya manda candle_ts, usamos eso
  const ct = last.candle_ts || null;

  if (ct){
    const idx = series.findIndex(x => x.candle_ts === ct);
    if (idx !== -1) return series[idx].gold;
  }

  // Fallback: aproximar al inicio del timeframe (por si no llega candle_ts)
  // Si meta.timeframe es "60m", redondea a la hora.
  const lastTs = new Date(last.ts);
  lastTs.setMinutes(0,0,0);
  const iso = lastTs.toISOString().replace(".000Z","+00:00"); // formato parecido
  const idx2 = series.findIndex(x => (x.candle_ts === iso));
  if (idx2 !== -1) return series[idx2].gold;

  // Ãšltimo fallback
  return series[0]?.gold ?? last.gold;
}

function updateLiveWidget(data, series, last){
  const titleEl = document.getElementById("liveTitle");
  const wickEl = document.getElementById("wick");
  const candleEl = document.getElementById("candle");
  const markerEl = document.getElementById("marker");
  const statsEl = document.getElementById("liveStats");

  if (!titleEl || !candleEl || !markerEl || !statsEl) return;

  // TÃ­tulo: activo + timeframe
  const tf = data?.meta?.timeframe || "â€”";
  titleEl.textContent = `GOLD Â· ${tf}`;

  const open = getCandleOpen(series, last);
  const price = last.gold;

  const delta = (price - open);
  const deltaPct = open ? (delta / open) * 100 : 0;

  // NormalizaciÃ³n para el â€œtermÃ³metroâ€
  // usamos ATR si existe, si no, un valor seguro
  const atr = last.atr ?? data?.state?.metrics?.atr ?? 25;
  const atrSafe = (atr && atr > 0) ? atr : 25;

  // map: centro 50% = sin cambio, +ATR => cerca 100%, -ATR => cerca 0%
  const pos = clamp(0.5 + (delta / (2 * atrSafe)), 0, 1);

  // Altura de vela: rellena hasta el marcador (mÃ­nimo 6%)
  const heightPct = clamp(pos * 100, 6, 100);

  candleEl.style.height = `${heightPct}%`;
  markerEl.style.bottom = `${pos * 100}%`;

  // Color â€œsensaciÃ³nâ€: verde si sube, rojo si baja (sin meter colores en el chart)
  // (en CSS ya tienes estilos neutros; aquÃ­ hacemos un toque suave)
  candleEl.style.background = delta >= 0 ? "rgba(120,255,170,.22)" : "rgba(255,120,140,.20)";
  markerEl.style.background = delta >= 0 ? "rgba(180,255,210,.95)" : "rgba(255,200,210,.95)";

  // Stats
  const rsi = last.gold_rsi14 ?? null;
  const ema21 = last.gold_ema21 ?? null;
  const ema50 = last.gold_ema50 ?? null;

  statsEl.innerHTML = `
    <div class="live-row"><span class="k">Precio</span><span class="v">${fmt(price,1)}</span></div>
    <div class="live-row"><span class="k">Open vela</span><span class="v">${fmt(open,1)}</span></div>
    <div class="live-row"><span class="k">Cambio</span><span class="v">${delta>=0?"+":""}${fmt(delta,1)} (${deltaPct>=0?"+":""}${fmt(deltaPct,2)}%)</span></div>
    <div class="live-row"><span class="k">EMA21</span><span class="v">${fmt(ema21,2)}</span></div>
    <div class="live-row"><span class="k">EMA50</span><span class="v">${fmt(ema50,2)}</span></div>
    <div class="live-row"><span class="k">RSI14</span><span class="v">${rsi==null ? "â€”" : fmt(rsi,2)}</span></div>
    <div class="live-row"><span class="k">ATR</span><span class="v">${fmt(atrSafe,2)}</span></div>
    <div class="live-row"><span class="k">Score</span><span class="v">${last.score}/100</span></div>
    <div class="live-row"><span class="k">Bias</span><span class="v">${last.bias || "â€”"}</span></div>
  `;
}

// ======= main fetch/render =======
async function loadData() {
  const res = await fetch('./macro_data.json', { cache: 'no-store' });
  const data = await res.json();
  const series = data.series || [];

  if (!series.length) {
    document.getElementById("updated").innerText = "Sin datos aÃºnâ€¦";
    return;
  }

  const last = series[series.length - 1];

  // ======= CABECERA =======
  document.getElementById("updated").innerText =
    "Actualizado: " + new Date(data.meta.updated_utc)
      .toLocaleString("es-ES", { timeZone: "Europe/Madrid" });

  document.getElementById("score").innerText = last.score + "/100";

  let biasText = "ðŸŸ¡ Mixto";
  let cls = "mix";
  if (last.bias === "LONG_FAVORABLE") { biasText = "ðŸŸ¢ LONG"; cls = "long"; }
  if (last.bias === "SHORT_CUIDADO") { biasText = "ðŸ”´ SHORT"; cls = "short"; }

  const biasEl = document.getElementById("bias");
  biasEl.innerText = biasText;
  biasEl.className = "badge " + cls;

  document.getElementById("gold").innerText = last.gold;

  // ======= WIDGET LIVE =======
  updateLiveWidget(data, series, last);

  // ======= SEÃ‘ALES =======
  const signals = (data.signals || []).slice(-10).reverse();
  const lastSignalText = document.getElementById("lastSignalText");
  const signalsList = document.getElementById("signalsList");

  function iconFor(t) {
    if (t === "BUY") return "ðŸŸ¢â¬†ï¸";
    if (t === "SELL") return "ðŸ”´â¬‡ï¸";
    if (t === "STOP_HIT") return "ðŸŸ ðŸ›‘";
    if (t === "CONFIRM_UP") return "ðŸŸ¦âœ…";
    return "ðŸŸ ðŸš¨";
  }

  if (!signals.length) {
    lastSignalText.textContent = "Sin seÃ±ales.";
    signalsList.innerHTML = "";
  } else {
    const lastSig = signals[0];
    lastSignalText.textContent =
      `${iconFor(lastSig.type)} ${lastSig.asset} â€” ${lastSig.type} â€” ${lastSig.reason}`;

    signalsList.innerHTML = signals.map(s => `
      <div class="card" style="padding:10px;">
        <div style="font-weight:700;">
          ${iconFor(s.type)} ${s.asset} â€” ${s.type} (fuerza ${s.strength})
        </div>
        <div style="opacity:.85">${s.reason}</div>
        <div style="opacity:.6; font-size:12px">${new Date(s.ts).toLocaleString("es-ES")}</div>
      </div>
    `).join("");
  }

  // ======= GRÃFICOS =======
  const labels = series.map(x =>
    new Date(x.ts).toLocaleString("es-ES", { timeZone: "Europe/Madrid" })
  );

  if (goldChartInstance) goldChartInstance.destroy();
  if (scoreChartInstance) scoreChartInstance.destroy();

  goldChartInstance = new Chart(document.getElementById("goldChart"), {
    type: "line",
    data: {
      labels,
      datasets: [
        { label: "Gold", data: series.map(x => x.gold) },
        { label: "EMA21", data: series.map(x => x.gold_ema21) },
        { label: "EMA50", data: series.map(x => x.gold_ema50) }
      ]
    },
    options: { responsive: true, maintainAspectRatio: false }
  });

  scoreChartInstance = new Chart(document.getElementById("scoreChart"), {
    type: "line",
    data: { labels, datasets: [{ label: "Score", data: series.map(x => x.score) }] },
    options: { responsive: true, maintainAspectRatio: false }
  });
}

// Arranque
startClock();
loadData();
setInterval(loadData, 30000);
</script>

</body>
</html>
