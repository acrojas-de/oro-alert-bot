<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Macro Dashboard (Oro)</title>

  <link rel="stylesheet" href="./style.css">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body>

  <!-- TOPBAR FIJA -->
  <div class="topbar">
    <div class="left">
      <div style="font-weight:800;">ðŸ“¡ Macro Dashboard</div>
      <div id="updated" style="opacity:.8;"></div>
    </div>

    <div class="right">
      <div class="card" style="margin:0; padding:8px 10px;">
        Score: <span id="score"></span> |
        Bias: <span id="bias" class="badge mix"></span> |
        Oro: <span id="gold"></span>
      </div>
    </div>
  </div>

  <!-- WIDGETS LIVE (4 velas en fila) -->
  <div class="live-row-wrap" id="liveRow">

    <div class="live-card" data-asset="gold" data-label="GOLD">
      <div class="live-header">
        <div class="live-title">GOLD Â· <span class="tf">--</span></div>
        <div class="live-clock">
          <span class="now">--:--:--</span>
          <span class="sep">Â·</span>
          <span class="left">--:--</span>
        </div>
      </div>

      <div class="live-body">
        <div class="thermo">
          <div class="wick"></div>
          <div class="candle"></div>
          <div class="marker"></div>
          <div class="price-float">--</div>
        </div>
        <div class="live-stats"></div>
      </div>
    </div>

    <div class="live-card" data-asset="dxy" data-label="DXY">
      <div class="live-header">
        <div class="live-title">DXY Â· <span class="tf">--</span></div>
        <div class="live-clock">
          <span class="now">--:--:--</span>
          <span class="sep">Â·</span>
          <span class="left">--:--</span>
        </div>
      </div>

      <div class="live-body">
        <div class="thermo">
          <div class="wick"></div>
          <div class="candle"></div>
          <div class="marker"></div>
          <div class="price-float">--</div>
        </div>
        <div class="live-stats"></div>
      </div>
    </div>

    <div class="live-card" data-asset="tnx" data-label="TNX">
      <div class="live-header">
        <div class="live-title">TNX Â· <span class="tf">--</span></div>
        <div class="live-clock">
          <span class="now">--:--:--</span>
          <span class="sep">Â·</span>
          <span class="left">--:--</span>
        </div>
      </div>

      <div class="live-body">
        <div class="thermo">
          <div class="wick"></div>
          <div class="candle"></div>
          <div class="marker"></div>
          <div class="price-float">--</div>
        </div>
        <div class="live-stats"></div>
      </div>
    </div>

    <div class="live-card" data-asset="nasdaq" data-label="NASDAQ">
      <div class="live-header">
        <div class="live-title">NASDAQ Â· <span class="tf">--</span></div>
        <div class="live-clock">
          <span class="now">--:--:--</span>
          <span class="sep">Â·</span>
          <span class="left">--:--</span>
        </div>
      </div>

      <div class="live-body">
        <div class="thermo">
          <div class="wick"></div>
          <div class="candle"></div>
          <div class="marker"></div>
          <div class="price-float">--</div>
        </div>
        <div class="live-stats"></div>
      </div>
    </div>

  </div>

  <!-- CONTENIDO (SCROLL INTERNO) -->
  <div class="main">

    <!-- PANEL DE SEÃ‘ALES -->
    <div id="signalsPanel" class="card">
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;">
        <div>
          <div style="font-weight:700;">SeÃ±ales</div>
          <div id="lastSignalText" style="opacity:.9;">(cargando...)</div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <a class="btn" href="https://www.etoro.com/" target="_blank"
             style="background:#1db954; color:#0b0f14; font-weight:800; text-decoration:none;">
            Abrir eToro
          </a>

          <a class="btn" href="https://www.binance.com/" target="_blank"
             style="background:#f0b90b; color:#0b0f14; font-weight:800; text-decoration:none;">
            Abrir Binance
          </a>
        </div>
      </div>

      <div id="signalsList" style="margin-top:10px; display:grid; gap:8px;"></div>
    </div>

    <!-- GRÃFICOS -->
    <div class="grid">
      <div class="chart-card">
        <div class="chart-wrap">
          <canvas id="goldChart"></canvas>
        </div>
      </div>

      <div class="chart-card">
        <div class="chart-wrap">
          <canvas id="scoreChart"></canvas>
        </div>
      </div>
    </div>

  </div> <!-- /main -->

<script>
let goldChartInstance = null;
let scoreChartInstance = null;

let clockTimer = null;
let liveTicker = null;
let lastDataCache = null;

// ======= helpers =======
function fmt(n, d=2){
  if (n === undefined || n === null || Number.isNaN(n)) return "â€”";
  return Number(n).toFixed(d);
}
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

// ===== reloj (todas las cards) =====
function startClockAll(){
  if (clockTimer) clearInterval(clockTimer);

  const tick = () => {
    const now = new Date();
    const t = now.toLocaleTimeString("es-ES", {
      timeZone: "Europe/Madrid",
      hour12: false
    });
    document.querySelectorAll(".live-card .now").forEach(el => el.textContent = t);
  };

  tick();
  clockTimer = setInterval(tick, 1000);
}

// timeframe string -> minutes
function tfToMinutes(tf){
  if (!tf || typeof tf !== "string") return 60;
  const s = tf.trim().toLowerCase();
  if (s.endsWith("m")) return parseInt(s,10) || 60;
  if (s.endsWith("h")) return (parseInt(s,10) || 1) * 60;
  if (s.endsWith("d")) return (parseInt(s,10) || 1) * 1440;
  return 60;
}

// calcula progreso vela 0..1 usando candle_ts si existe; si no, aproximaciÃ³n por redondeo
function candleStartMs(last, tfMin){
  if (last?.candle_ts){
    const ms = new Date(last.candle_ts).getTime();
    if (!Number.isNaN(ms)) return ms;
  }

  const t = new Date(last?.ts || Date.now());
  const ms = t.getTime();

  // aproximaciÃ³n: redondeo hacia abajo al bloque tfMin
  const block = tfMin * 60 * 1000;
  return Math.floor(ms / block) * block;
}

function updateTimeLeftUI(tfMin, startMs){
  const endMs = startMs + tfMin*60*1000;
  const leftMs = Math.max(0, endMs - Date.now());
  const leftMin = Math.floor(leftMs / 60000);
  const leftSec = Math.floor((leftMs % 60000) / 1000);

  const mm = String(leftMin).padStart(2,"0");
  const ss = String(leftSec).padStart(2,"0");

  document.querySelectorAll(".live-card .left").forEach(el => el.textContent = `-${mm}:${ss}`);
}

function findOpen(series, last, key, startMs){
  // 1) ideal: buscar primer punto de esa vela por candle_ts
  if (last?.candle_ts){
    const row = series.find(x => x.candle_ts === last.candle_ts);
    if (row && row[key] != null) return row[key];
  }

  // 2) buscar el primer dato cuyo ts estÃ© dentro de la vela actual (>= start)
  const row2 = series.find(x => {
    const ms = new Date(x.ts).getTime();
    return !Number.isNaN(ms) && ms >= startMs;
  });
  if (row2 && row2[key] != null) return row2[key];

  // 3) fallback
  return series[0]?.[key] ?? last?.[key];
}

function updateLiveRowFromCache(){
  if (!lastDataCache) return;

  const data = lastDataCache;
  const series = data.series || [];
  if (!series.length) return;
  const last = series[series.length - 1];

  const tf = data?.meta?.timeframe || "60m";
  const tfMin = tfToMinutes(tf);
  const startMs = candleStartMs(last, tfMin);
  const endMs = startMs + tfMin*60*1000;
  const prog = clamp((Date.now() - startMs) / (endMs - startMs), 0, 1);

  // UI: tf y time-left
  document.querySelectorAll(".live-card .tf").forEach(el => el.textContent = tf);
  updateTimeLeftUI(tfMin, startMs);

  // Mapa de assets (ajusta decimales si quieres)
  const map = {
    gold:   { key:"gold",   label:"GOLD",   atrKey:"atr",        decimals:1 },
    dxy:    { key:"dxy",    label:"DXY",    atrKey:null,         decimals:3 },
    tnx:    { key:"tnx",    label:"TNX",    atrKey:null,         decimals:3 },
    nasdaq: { key:"nasdaq", label:"NASDAQ", atrKey:null,         decimals:1 },
  };

  document.querySelectorAll(".live-card").forEach(card => {
    const asset = card.dataset.asset;
    const cfg = map[asset];
    if (!cfg) return;

    const price = last?.[cfg.key];
    if (price == null) return;

    const open = findOpen(series, last, cfg.key, startMs);
    const delta = price - open;

    // escala (ATR para oro; para otros un rango relativo simple)
    let scale = 1;
    if (cfg.atrKey && last?.[cfg.atrKey] != null) {
      scale = Math.max(Number(last[cfg.atrKey]) || 25, 0.00001);
    } else {
      // rango relativo: 0.2% del valor (mÃ­nimo)
      scale = Math.max(Math.abs(price) * 0.002, 0.00001);
    }

    // pos 0..1 centrado
    const pos = clamp(0.5 + (delta / (2 * scale)), 0, 1);

    const candle = card.querySelector(".candle");
    const marker = card.querySelector(".marker");
    const floatP = card.querySelector(".price-float");
    const stats  = card.querySelector(".live-stats");
    if (!candle || !marker || !floatP || !stats) return;

    // altura vela + marcador + precio flotante
    candle.style.height = `${clamp(pos*100, 6, 100)}%`;
    marker.style.bottom = `${pos*100}%`;
    floatP.style.bottom = `${pos*100}%`;
    floatP.textContent = fmt(price, cfg.decimals);

    candle.classList.remove("c-up","c-down");
    candle.classList.add(delta >= 0 ? "c-up" : "c-down");

    // stats: Open/Close + progreso
    stats.innerHTML = `
      <div class="live-row"><span class="k">Open</span><span class="v">${fmt(open, cfg.decimals)}</span></div>
      <div class="live-row"><span class="k">Last</span><span class="v">${fmt(price, cfg.decimals)}</span></div>
      <div class="live-row"><span class="k">Î”</span><span class="v">${delta>=0?"+":""}${fmt(delta, cfg.decimals)}</span></div>
      <div class="live-row"><span class="k">Progreso</span><span class="v">${Math.round(prog*100)}%</span></div>
    `;
  });
}

function startLiveTicker(){
  if (liveTicker) clearInterval(liveTicker);
  liveTicker = setInterval(updateLiveRowFromCache, 1000); // â€œcorreâ€ cada segundo
}

// ======= main fetch/render =======
async function loadData() {
  const res = await fetch('./macro_data.json', { cache: 'no-store' });
  const data = await res.json();
  const series = data.series || [];

  if (!series.length) {
    document.getElementById("updated").innerText = "Sin datos aÃºnâ€¦";
    return;
  }

  // cache para animaciÃ³n del widget cada segundo
  lastDataCache = data;

  const last = series[series.length - 1];

  // CABECERA
  document.getElementById("updated").innerText =
    "Actualizado: " + new Date(data.meta.updated_utc)
      .toLocaleString("es-ES", { timeZone: "Europe/Madrid" });

  document.getElementById("score").innerText = last.score + "/100";

  let biasText = "ðŸŸ¡ Mixto";
  let cls = "mix";
  if (last.bias === "LONG_FAVORABLE") { biasText = "ðŸŸ¢ LONG"; cls = "long"; }
  if (last.bias === "SHORT_CUIDADO") { biasText = "ðŸ”´ SHORT"; cls = "short"; }

  const biasEl = document.getElementById("bias");
  biasEl.innerText = biasText;
  biasEl.className = "badge " + cls;

  document.getElementById("gold").innerText = last.gold;

  // LIVE 4 VELAS (pinta una vez y luego el ticker lo anima)
  updateLiveRowFromCache();

  // SEÃ‘ALES
  const signals = (data.signals || []).slice(-10).reverse();
  const lastSignalText = document.getElementById("lastSignalText");
  const signalsList = document.getElementById("signalsList");

  function iconFor(t) {
    if (t === "BUY") return "ðŸŸ¢â¬†ï¸";
    if (t === "SELL") return "ðŸ”´â¬‡ï¸";
    if (t === "STOP_HIT") return "ðŸŸ ðŸ›‘";
    if (t === "CONFIRM_UP") return "ðŸŸ¦âœ…";
    return "ðŸŸ ðŸš¨";
  }

  if (!signals.length) {
    lastSignalText.textContent = "Sin seÃ±ales.";
    signalsList.innerHTML = "";
  } else {
    const lastSig = signals[0];
    lastSignalText.textContent =
      `${iconFor(lastSig.type)} ${lastSig.asset} â€” ${lastSig.type} â€” ${lastSig.reason}`;

    signalsList.innerHTML = signals.map(s => `
      <div class="card" style="padding:10px;">
        <div style="font-weight:700;">
          ${iconFor(s.type)} ${s.asset} â€” ${s.type} (fuerza ${s.strength})
        </div>
        <div style="opacity:.85">${s.reason}</div>
        <div style="opacity:.6; font-size:12px">${new Date(s.ts).toLocaleString("es-ES")}</div>
      </div>
    `).join("");
  }

  // GRÃFICOS
  const labels = series.map(x =>
    new Date(x.ts).toLocaleString("es-ES", { timeZone: "Europe/Madrid" })
  );

  if (goldChartInstance) goldChartInstance.destroy();
  if (scoreChartInstance) scoreChartInstance.destroy();

  goldChartInstance = new Chart(document.getElementById("goldChart"), {
    type: "line",
    data: {
      labels,
      datasets: [
        { label: "Gold", data: series.map(x => x.gold) },
        { label: "EMA21", data: series.map(x => x.gold_ema21) },
        { label: "EMA50", data: series.map(x => x.gold_ema50) }
      ]
    },
    options: { responsive: true, maintainAspectRatio: false }
  });

  scoreChartInstance = new Chart(document.getElementById("scoreChart"), {
    type: "line",
    data: { labels, datasets: [{ label: "Score", data: series.map(x => x.score) }] },
    options: { responsive: true, maintainAspectRatio: false }
  });
}

// Arranque
startClockAll();
startLiveTicker();
loadData();
setInterval(loadData, 30000);
</script>

</body>
</html>
