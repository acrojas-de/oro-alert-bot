<!doctype html>
<html lang="es">
<head>
  <link rel="stylesheet" href="./style.css">
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Macro Dashboard (Oro)</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

</head>

<body>

  <!-- TOPBAR FIJA -->
  <div class="topbar">
    <div class="left">
      <div style="font-weight:800;">ðŸ“¡ Macro Dashboard</div>
      <div id="updated" style="opacity:.8;"></div>
    </div>

    <div class="right">
      <div class="card" style="margin:0; padding:8px 10px;">
        Score: <span id="score"></span> |
        Bias: <span id="bias" class="badge mix"></span> |
        Oro: <span id="gold"></span>
      </div>
    </div>
  </div>

  <!-- WIDGET VELA-TERMÃ“METRO + RELOJ -->
  <!-- WIDGETS LIVE (4 velas en fila) -->
<div class="live-row-wrap" id="liveRow">
  <div class="live-card" data-asset="gold" data-label="GOLD">
    <div class="live-header">
      <div class="live-title">GOLD Â· <span class="tf">--</span></div>
      <div class="live-clock">
        <span class="now">--:--:--</span>
        <span class="sep">Â·</span>
        <span class="left">--:--</span>
      </div>
    </div>

    <div class="live-body">
      <div class="thermo">
        <div class="wick"></div>
        <div class="candle"></div>
        <div class="marker"></div>
        <div class="price-float">--</div>
      </div>

      <div class="live-stats"></div>
    </div>
  </div>

  <div class="live-card" data-asset="dxy" data-label="DXY">
    <div class="live-header">
      <div class="live-title">DXY Â· <span class="tf">--</span></div>
      <div class="live-clock">
        <span class="now">--:--:--</span>
        <span class="sep">Â·</span>
        <span class="left">--:--</span>
      </div>
    </div>

    <div class="live-body">
      <div class="thermo">
        <div class="wick"></div>
        <div class="candle"></div>
        <div class="marker"></div>
        <div class="price-float">--</div>
      </div>

      <div class="live-stats"></div>
    </div>
  </div>

  <div class="live-card" data-asset="tnx" data-label="TNX">
    <div class="live-header">
      <div class="live-title">TNX Â· <span class="tf">--</span></div>
      <div class="live-clock">
        <span class="now">--:--:--</span>
        <span class="sep">Â·</span>
        <span class="left">--:--</span>
      </div>
    </div>

    <div class="live-body">
      <div class="thermo">
        <div class="wick"></div>
        <div class="candle"></div>
        <div class="marker"></div>
        <div class="price-float">--</div>
      </div>

      <div class="live-stats"></div>
    </div>
  </div>

  <div class="live-card" data-asset="nasdaq" data-label="NASDAQ">
    <div class="live-header">
      <div class="live-title">NASDAQ Â· <span class="tf">--</span></div>
      <div class="live-clock">
        <span class="now">--:--:--</span>
        <span class="sep">Â·</span>
        <span class="left">--:--</span>
      </div>
    </div>

    <div class="live-body">
      <div class="thermo">
        <div class="wick"></div>
        <div class="candle"></div>
        <div class="marker"></div>
        <div class="price-float">--</div>
      </div>

      <div class="live-stats"></div>
    </div>
  </div>
</div>

  <!-- CONTENIDO (SCROLL INTERNO) -->
  <div class="main">

    <!-- âœ… PANEL DE SEÃ‘ALES -->
    <div id="signalsPanel" class="card">
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;">
        <div>
          <div style="font-weight:700;">SeÃ±ales</div>
          <div id="lastSignalText" style="opacity:.9;">(cargando...)</div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <a class="btn" href="https://www.etoro.com/" target="_blank"
             style="background:#1db954; color:#0b0f14; font-weight:800; text-decoration:none;">
            Abrir eToro
          </a>

          <a class="btn" href="https://www.binance.com/" target="_blank"
             style="background:#f0b90b; color:#0b0f14; font-weight:800; text-decoration:none;">
            Abrir Binance
          </a>
        </div>
      </div>

      <div id="signalsList" style="margin-top:10px; display:grid; gap:8px;"></div>
    </div>

    <!-- GRÃFICOS -->
    <div class="grid">
      <div class="chart-card">
        <div class="chart-wrap">
          <canvas id="goldChart"></canvas>
        </div>
      </div>

      <div class="chart-card">
        <div class="chart-wrap">
          <canvas id="scoreChart"></canvas>
        </div>
      </div>
    </div>

  </div> <!-- /main -->

  <script>
let goldChartInstance = null;
let scoreChartInstance = null;

let clockTimer = null;

// ===== helpers =====
function fmt(n, d=2){
  if (n === undefined || n === null || Number.isNaN(n)) return "â€”";
  return Number(n).toFixed(d);
}
function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }

function startClock(){
  const tick = () => {
    const now = new Date();
    // reloj general si existe
    const g = document.getElementById("liveClock");
    if (g){
      g.textContent = now.toLocaleTimeString("es-ES", {
        timeZone:"Europe/Madrid", hour12:false
      });
    }
    // relojes por vela (si existen)
    document.querySelectorAll(".c-clock").forEach(el=>{
      el.textContent = now.toLocaleTimeString("es-ES", {
        timeZone:"Europe/Madrid", hour12:false
      });
    });
  };
  tick();
  if (clockTimer) clearInterval(clockTimer);
  clockTimer = setInterval(tick, 1000);
}

// ---- timeframe -> minutos (para floor correcto) ----
function tfToMinutes(tf){
  const s = String(tf || "").trim().toLowerCase();
  if (s.endsWith("m")) return parseInt(s,10);
  if (s.endsWith("h")) return parseInt(s,10) * 60;
  if (s.endsWith("d")) return parseInt(s,10) * 60 * 24;
  return 60;
}
function floorToTfISO(tsIso, tfMinutes){
  const d = new Date(tsIso);
  const ms = d.getTime();
  const step = tfMinutes * 60 * 1000;
  const floored = new Date(Math.floor(ms/step)*step);
  return floored.toISOString().replace(".000Z","+00:00");
}

// ---- busca OPEN de la vela actual por candle_ts ----
function getOpenFor(series, candleTs, field, fallbackLast){
  if (!series.length) return fallbackLast;
  // 1) intenta con candle_ts exacto
  const first = series.find(x => x.candle_ts === candleTs && x[field] != null);
  if (first) return first[field];

  // 2) fallback: primer valor que encuentre del campo
  const any = series.find(x => x[field] != null);
  return any ? any[field] : fallbackLast;
}

function setCard(cardId, payload){
  const root = document.getElementById(cardId);
  if (!root) return;

  const elOpen  = root.querySelector(".c-open");
  const elClose = root.querySelector(".c-close");
  const elBody  = root.querySelector(".c-body");
  const elWick  = root.querySelector(".c-wick");

  const {open, close, high, low, dir, progress, labelTop, labelBottom} = payload;

  if (elOpen)  elOpen.textContent  = labelTop;
  if (elClose) elClose.textContent = labelBottom;

  // cuerpo: tamaÃ±o segÃºn rango (si no hay high/low reales, usamos delta)
  const range = (high != null && low != null) ? Math.max(0.000001, high-low) : Math.max(0.000001, Math.abs(close-open));
  const bodyPct = clamp(Math.abs(close-open) / range, 0.08, 1) * 100;

  // wick: altura total 100%
  if (elWick) elWick.style.height = "100%";
  if (elBody){
    elBody.style.height = `${bodyPct}%`;

    // color direcciÃ³n (verde/rojo)
    elBody.style.background = dir >= 0 ? "rgba(120,255,170,.22)" : "rgba(255,120,140,.20)";
    elBody.style.borderColor = dir >= 0 ? "rgba(120,255,170,.35)" : "rgba(255,120,140,.35)";
    elBody.style.bottom = dir >= 0 ? "0" : "0";
  }

  // progreso lateral (si en CSS lo dibujas como pseudo o barra aparte)
  // Si tienes un div .c-progress dentro:
  const elProg = root.querySelector(".c-progress");
  if (elProg){
    elProg.style.height = `${clamp(progress,0,1)*100}%`;
  }
}

function update4Candles(data){
  const series = data.series || [];
  if (!series.length) return;

  const last = series[series.length - 1];
  const tf = data?.meta?.timeframe || "60m";
  const tfMin = tfToMinutes(tf);

  // candle_ts: si no viene, lo calculamos
  const candleTs = last.candle_ts || floorToTfISO(last.ts, tfMin);

  // OPEN por activo (primera lectura dentro de esa candle_ts)
  const openGold = getOpenFor(series, candleTs, "gold", last.gold);
  const openDxy  = getOpenFor(series, candleTs, "dxy", last.dxy);
  const openTnx  = getOpenFor(series, candleTs, "tnx", last.tnx);
  const openNas  = getOpenFor(series, candleTs, "nasdaq", last.nasdaq);

  // CLOSE = el Ãºltimo valor
  const closeGold = last.gold;
  const closeDxy  = last.dxy;
  const closeTnx  = last.tnx;
  const closeNas  = last.nasdaq;

  // progreso de la vela (por tiempo dentro del timeframe)
  const startMs = new Date(candleTs.replace("+00:00","Z")).getTime();
  const nowMs = Date.now();
  const endMs = startMs + tfMin*60*1000;
  const progress = clamp((nowMs - startMs) / (endMs - startMs), 0, 1);

  // Labels: arriba = close, abajo = open (como tÃº quieres)
  setCard("cGold", {
    open: openGold, close: closeGold,
    dir: closeGold - openGold,
    progress,
    labelTop: fmt(closeGold,1),
    labelBottom: fmt(openGold,1)
  });

  setCard("cDxy", {
    open: openDxy, close: closeDxy,
    dir: closeDxy - openDxy,
    progress,
    labelTop: fmt(closeDxy,3),
    labelBottom: fmt(openDxy,3)
  });

  setCard("cTnx", {
    open: openTnx, close: closeTnx,
    dir: closeTnx - openTnx,
    progress,
    labelTop: fmt(closeTnx,3),
    labelBottom: fmt(openTnx,3)
  });

  setCard("cNas", {
    open: openNas, close: closeNas,
    dir: closeNas - openNas,
    progress,
    labelTop: fmt(closeNas,2),
    labelBottom: fmt(openNas,2)
  });
}

// ===== main fetch/render =====
async function loadData() {
  const res = await fetch('./macro_data.json', { cache: 'no-store' });
  const data = await res.json();
  const series = data.series || [];

  if (!series.length) {
    document.getElementById("updated").innerText = "Sin datos aÃºnâ€¦";
    return;
  }

  const last = series[series.length - 1];

  // CABECERA
  document.getElementById("updated").innerText =
    "Actualizado: " + new Date(data.meta.updated_utc)
      .toLocaleString("es-ES", { timeZone: "Europe/Madrid" });

  document.getElementById("score").innerText = last.score + "/100";

  let biasText = "ðŸŸ¡ Mixto";
  let cls = "mix";
  if (last.bias === "LONG_FAVORABLE") { biasText = "ðŸŸ¢ LONG"; cls = "long"; }
  if (last.bias === "SHORT_CUIDADO") { biasText = "ðŸ”´ SHORT"; cls = "short"; }

  const biasEl = document.getElementById("bias");
  biasEl.innerText = biasText;
  biasEl.className = "badge " + cls;

  document.getElementById("gold").innerText = last.gold;

  // âœ… NUEVO WIDGET 4 VELAS
  update4Candles(data);

  // ===== SEÃ‘ALES (igual que antes) =====
  const signals = (data.signals || []).slice(-10).reverse();
  const lastSignalText = document.getElementById("lastSignalText");
  const signalsList = document.getElementById("signalsList");

  function iconFor(t) {
    if (t === "BUY") return "ðŸŸ¢â¬†ï¸";
    if (t === "SELL") return "ðŸ”´â¬‡ï¸";
    if (t === "STOP_HIT") return "ðŸŸ ðŸ›‘";
    if (t === "CONFIRM_UP") return "ðŸŸ¦âœ…";
    return "ðŸŸ ðŸš¨";
  }

  if (!signals.length) {
    lastSignalText.textContent = "Sin seÃ±ales.";
    signalsList.innerHTML = "";
  } else {
    const lastSig = signals[0];
    lastSignalText.textContent =
      `${iconFor(lastSig.type)} ${lastSig.asset} â€” ${lastSig.type} â€” ${lastSig.reason}`;

    signalsList.innerHTML = signals.map(s => `
      <div class="card" style="padding:10px;">
        <div style="font-weight:700;">
          ${iconFor(s.type)} ${s.asset} â€” ${s.type} (fuerza ${s.strength})
        </div>
        <div style="opacity:.85">${s.reason}</div>
        <div style="opacity:.6; font-size:12px">${new Date(s.ts).toLocaleString("es-ES")}</div>
      </div>
    `).join("");
  }

  // ===== GRÃFICOS (igual que antes) =====
  const labels = series.map(x =>
    new Date(x.ts).toLocaleString("es-ES", { timeZone: "Europe/Madrid" })
  );

  if (goldChartInstance) goldChartInstance.destroy();
  if (scoreChartInstance) scoreChartInstance.destroy();

  goldChartInstance = new Chart(document.getElementById("goldChart"), {
    type: "line",
    data: {
      labels,
      datasets: [
        { label: "Gold", data: series.map(x => x.gold) },
        { label: "EMA21", data: series.map(x => x.gold_ema21) },
        { label: "EMA50", data: series.map(x => x.gold_ema50) }
      ]
    },
    options: { responsive: true, maintainAspectRatio: false }
  });

  scoreChartInstance = new Chart(document.getElementById("scoreChart"), {
    type: "line",
    data: { labels, datasets: [{ label: "Score", data: series.map(x => x.score) }] },
    options: { responsive: true, maintainAspectRatio: false }
  });
}

// Arranque
startClock();
loadData();
setInterval(loadData, 30000);
</script>
 
</body>
</html>
