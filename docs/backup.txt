<!doctype html>
<html lang="es">
<head>
  <link rel="stylesheet" href="./style.css">
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Macro Dashboard (Oro)</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

</head>

<body>

  <!-- TOPBAR FIJA -->
  <div class="topbar">
    <div class="left">
      <div style="font-weight:800;">ðŸ“¡ Macro Dashboard</div>
      <div id="updated" style="opacity:.8;"></div>
    </div>

    <div class="right">
      <div class="card" style="margin:0; padding:8px 10px;">
        Score: <span id="score"></span> |
        Bias: <span id="bias" class="badge mix"></span> |
        Oro: <span id="gold"></span>
      </div>
    </div>
  </div>

  <!-- CONTENIDO (SCROLL INTERNO) -->
  <div class="main">
    <!-- âœ… PANEL DE SEÃ‘ALES -->
    <div id="signalsPanel" class="card">
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;">
        <div>
          <div style="font-weight:700;">SeÃ±ales</div>
          <div id="lastSignalText" style="opacity:.9;">(cargando...)</div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <a class="btn" href="https://www.etoro.com/" target="_blank"
             style="background:#1db954; color:#0b0f14; font-weight:800; text-decoration:none;">
            Abrir eToro
          </a>

          <a class="btn" href="https://www.binance.com/" target="_blank"
             style="background:#f0b90b; color:#0b0f14; font-weight:800; text-decoration:none;">
            Abrir Binance
          </a>
        </div>
      </div>

      <div id="signalsList" style="margin-top:10px; display:grid; gap:8px;"></div>
    </div>

    <!-- GRÃFICOS -->
    <div class="grid">
      <div class="chart-card">
        <div class="chart-wrap">
          <canvas id="goldChart"></canvas>
        </div>
      </div>

      <div class="chart-card">
        <div class="chart-wrap">
          <canvas id="scoreChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
let goldChartInstance = null;
let scoreChartInstance = null;

async function loadData() {
  const res = await fetch('./macro_data.json', { cache: 'no-store' });
  const data = await res.json();
  const series = data.series || [];

  // âœ… si no hay datos, salimos sin romper
  if (!series.length) {
    document.getElementById("updated").innerText = "Sin datos aÃºnâ€¦";
    return;
  }

  const last = series[series.length - 1];

  // ======= CABECERA =======
  document.getElementById("updated").innerText =
    "Actualizado: " + new Date(data.meta.updated_utc)
      .toLocaleString("es-ES", { timeZone: "Europe/Madrid" });

  document.getElementById("score").innerText = last.score + "/100";

  let biasText = "ðŸŸ¡ Mixto";
  let cls = "mix";
  if (last.bias === "LONG_FAVORABLE") { biasText = "ðŸŸ¢ LONG"; cls = "long"; }
  if (last.bias === "SHORT_CUIDADO") { biasText = "ðŸ”´ SHORT"; cls = "short"; }

  const biasEl = document.getElementById("bias");
  biasEl.innerText = biasText;
  biasEl.className = "badge " + cls;

  document.getElementById("gold").innerText = last.gold;

  // ======= SEÃ‘ALES =======
  const signals = (data.signals || []).slice(-10).reverse();
  const lastSignalText = document.getElementById("lastSignalText");
  const signalsList = document.getElementById("signalsList");

  function iconFor(t) {
    if (t === "BUY") return "ðŸŸ¢â¬†ï¸";
    if (t === "SELL") return "ðŸ”´â¬‡ï¸";
    return "ðŸŸ ðŸš¨";
  }

  if (!signals.length) {
    lastSignalText.textContent = "Sin seÃ±ales.";
    signalsList.innerHTML = "";
  } else {
    const lastSig = signals[0];
    lastSignalText.textContent =
      `${iconFor(lastSig.type)} ${lastSig.asset} â€” ${lastSig.type} â€” ${lastSig.reason}`;

    signalsList.innerHTML = signals.map(s => `
      <div class="card" style="padding:10px;">
        <div style="font-weight:700;">
          ${iconFor(s.type)} ${s.asset} â€” ${s.type} (fuerza ${s.strength})
        </div>
        <div style="opacity:.85">${s.reason}</div>
        <div style="opacity:.6; font-size:12px">${new Date(s.ts).toLocaleString("es-ES")}</div>
      </div>
    `).join("");
  }

  // ======= GRÃFICOS =======
  const labels = series.map(x =>
    new Date(x.ts).toLocaleString("es-ES", { timeZone: "Europe/Madrid" })
  );

  // âœ… destruir ANTES de crear nuevos (evita duplicados)
  if (goldChartInstance) goldChartInstance.destroy();
  if (scoreChartInstance) scoreChartInstance.destroy();

  goldChartInstance = new Chart(document.getElementById("goldChart"), {
    type: "line",
    data: {
      labels,
      datasets: [
        { label: "Gold", data: series.map(x => x.gold) },
        { label: "EMA21", data: series.map(x => x.gold_ema21) },
        { label: "EMA50", data: series.map(x => x.gold_ema50) }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });

  scoreChartInstance = new Chart(document.getElementById("scoreChart"), {
    type: "line",
    data: {
      labels,
      datasets: [
        { label: "Score", data: series.map(x => x.score) }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });
}

// âœ… 1Âª carga + refresco cada 30s
loadData();
setInterval(loadData, 30000);
  </script>

</body>
</html>
