<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Premium Terminal V1</title>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
    }

    header {
      padding: 15px;
      background: #1e293b;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 14px;
      flex-wrap: wrap;
    }

    select {
      padding: 6px 10px;
      background: #0f172a;
      color: white;
      border: 1px solid #334155;
      border-radius: 6px;
    }

    .content { padding: 20px; }

    .card {
      background: #1e293b;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 1px solid rgba(148,163,184,0.12);
    }

    /* ===== Velocímetro ===== */
    .gaugeWrap{
      display:flex;
      gap:18px;
      align-items:center;
      flex-wrap:wrap;
    }

    .gauge{
      width:260px;
      max-width:100%;
      height:auto;
    }

    .gBg{
      fill:none;
      stroke:#334155;
      stroke-width:14;
      stroke-linecap:round;
    }

    .gFg{
      fill:none;
      stroke: var(--gauge, #94a3b8);
      stroke-width:14;
      stroke-linecap:round;
      stroke-dasharray: 251.2;
      stroke-dashoffset: 251.2;
      transition: stroke-dashoffset 400ms ease, stroke 200ms ease;
    }

    .gScore{
      font-size:28px;
      font-weight:800;
      fill:#e2e8f0;
    }

    .gLabel{
      font-size:12px;
      fill:#94a3b8;
      letter-spacing:0.5px;
      text-transform:uppercase;
    }

    /* ===== UI PRO (chips) ===== */
    .rowTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:16px;
    }

    .badges{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin:10px 0 14px;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border:1px solid #334155;
      border-radius:999px;
      background: rgba(15,23,42,0.55);
      font-size:12px;
      color:#e2e8f0;
    }

    .badge b{ font-weight:700; color:#94a3b8; }

    .dot{
      width:8px; height:8px; border-radius:50%;
      background:#94a3b8;
      box-shadow: 0 0 0 3px rgba(148,163,184,0.15);
    }

    .dot.up{
      background:#22c55e;
      box-shadow: 0 0 0 3px rgba(34,197,94,0.15);
    }
    .dot.down{
      background:#ef4444;
      box-shadow: 0 0 0 3px rgba(239,68,68,0.15);
    }

    /* ===== MARKET STATE (PRO) ===== */
    .stateBar{
      margin: 10px 0 14px;
      padding: 12px 14px;
      border: 1px solid #334155;
      border-radius: 14px;
      background: rgba(15,23,42,0.35);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }

    .stateLeft{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .statePill{
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
      letter-spacing: 0.4px;
      border: 1px solid #334155;
      background: rgba(2,6,23,0.35);
    }

    .stateText{
      font-size: 14px;
      color: #e2e8f0;
      font-weight: 700;
    }

    .stateHint{
      font-size: 12px;
      color:#94a3b8;
    }

    .statePill.up{ border-color: rgba(34,197,94,0.45); }
    .statePill.down{ border-color: rgba(239,68,68,0.45); }
    .statePill.neutral{ border-color: rgba(148,163,184,0.45); }

    /* ===== TOAST ALERT ===== */
    .toast{
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 14px 18px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 13px;
      color: white;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      z-index: 9999;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s ease;
    }
    .toast.show{ opacity: 1; transform: translateY(0); }
    .toast.up{ background: #22c55e; }
    .toast.down{ background: #ef4444; }

    /* ===== Gauge color by score ===== */
    .gauge-red  { --gauge: #ef4444; }
    .gauge-amber{ --gauge: #f59e0b; }
    .gauge-green{ --gauge: #22c55e; }

    /* ===== Card tint by signal ===== */
    .card.tone-up{
      border-color: rgba(34,197,94,.35);
      box-shadow: 0 0 0 1px rgba(34,197,94,.08), 0 12px 40px rgba(0,0,0,.25);
    }
    .card.tone-down{
      border-color: rgba(239,68,68,.35);
      box-shadow: 0 0 0 1px rgba(239,68,68,.08), 0 12px 40px rgba(0,0,0,.25);
    }
    #gFg { filter: drop-shadow(0 0 6px rgba(255,255,255,.18)); }

    /* ===== LAYOUT 2 COLUMNAS (GAUGE + RADAR) ===== */
    .layout2{
      display:grid;
      grid-template-columns: 320px 1fr;
      gap: 14px;
      align-items: start;
      margin-top: 10px;
    }
    @media (max-width: 980px){
      .layout2{ grid-template-columns: 1fr; }
    }

    .radarHeader{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
      margin: 2px 0 10px;
    }
    .radarTitle{
      font-weight:900;
      letter-spacing:.6px;
      font-size:12px;
      color:#e2e8f0;
    }
    .radarHint{
      font-size:12px;
      color:#94a3b8;
    }

    /* ===== RADAR LIST ===== */
    .radarList{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .radarItem {
      display: grid;
      grid-template-columns: 120px 1fr auto;
      align-items: center;
      padding: 8px 14px;
      border: 1px solid #334155;
      border-radius: 10px;
      background: rgba(15,23,42,0.35);
      cursor: pointer;
      transition: all .15s ease;
    }

    .radarItem:hover {
      background: rgba(15,23,42,0.6);
      transform: translateY(-1px);
    }

    .radarSym{
      font-weight:900;
      font-size:13px;
    }
    .radarMeta{
      font-size:12px;
      color:#94a3b8;
    }
    .radarPrice{
      font-weight:900;
      font-size:14px;
      text-align:right;
    }
    .radarEma{
      font-size:12px;
      color:#94a3b8;
      text-align:right;
    }

  .refreshBtn{
  margin-left:12px;
  padding:6px 12px;
  background:#0f172a;
  border:1px solid #334155;
  color:#e2e8f0;
  border-radius:8px;
  cursor:pointer;
  font-weight:700;
  transition: all .15s ease;
}

.refreshBtn:hover{
  background:#1e293b;
  transform: translateY(-1px);
}

.refreshBtn:active{
  transform: translateY(0);
}

   .bloomberg-structure{
  margin-top:14px;
  border:1px solid rgba(255,255,255,.08);
  border-radius:16px;
  padding:12px;
  background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.06));
  box-shadow: 0 10px 30px rgba(0,0,0,.25);
}

.bb-head{
  display:flex;
  justify-content:space-between;
  align-items:baseline;
  margin-bottom:10px;
}
.bb-title{
  font-weight:700;
  letter-spacing:.12em;
  font-size:12px;
  opacity:.9;
}
.bb-sub{
  font-size:12px;
  opacity:.75;
}

.bb-chart-wrap{
  border:1px solid rgba(255,255,255,.08);
  border-radius:14px;
  padding:10px;
  background: rgba(0,0,0,.18);
}

.bb-meters{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-top:10px;
}
.bb-meter{
  border:1px solid rgba(255,255,255,.08);
  border-radius:14px;
  padding:10px;
  background: rgba(0,0,0,.14);
}
.bb-meter-label{
  display:flex;
  justify-content:space-between;
  font-size:12px;
  opacity:.9;
  margin-bottom:8px;
}
.bb-bar{
  height:10px;
  border-radius:999px;
  background: rgba(255,255,255,.08);
  overflow:hidden;
}
.bb-bar-fill{
  height:100%;
  width:0%;
  border-radius:999px;
  background: rgba(130,255,180,.75); /* base; luego JS cambia */
  box-shadow: 0 0 20px rgba(130,255,180,.25);
}
.bb-meter-hint{
  margin-top:8px;
  font-size:12px;
  opacity:.75;
}

.bb-decision{
  margin-top:10px;
  border-radius:16px;
  padding:12px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.18);
}
.bb-decision-mode{
  font-weight:800;
  font-size:14px;
  letter-spacing:.08em;
  margin-bottom:6px;
}
.bb-decision-line{
  font-size:12px;
  opacity:.85;
  line-height:1.35;
} 
    
  </style>
</head>

<body>
 <header>
  <h2 style="margin:0;">Premium Terminal V1 (1H)</h2>
  <select id="assetSelect"></select>

  <button id="refreshBtn" class="refreshBtn">↻ Refresh</button>

  <div id="dataHealth" style="opacity:.85;font-size:12px;"></div>
</header>

  <div class="content">
    <div id="mainCard" class="card">
      <div class="rowTop">
        <div>
          <h3 id="assetName" style="margin:0;">Selecciona un activo</h3>

          <div class="badges">
            <span id="badgeSignal" class="badge">
              <span id="sigDot" class="dot"></span>
              <b>Señal</b> <span id="uiSignal">—</span>
            </span>
            <span id="badgeTrend" class="badge"><b>Tendencia</b> <span id="uiTrend">—</span></span>
            <span id="badgeVol" class="badge"><b>Volatilidad</b> <span id="uiVol">—</span></span>
            <span class="badge"><b>Updated</b> <span id="uiUpdated">—</span></span>
            <span class="badge"><b>TF</b> 1H</span>
          </div>
        </div>
      </div>

      <div class="stateBar">
        <div class="stateLeft">
          <span id="uiStatePill" class="statePill neutral">ESTADO</span>
          <span id="uiStateText" class="stateText">—</span>
        </div>
        <span id="uiStateHint" class="stateHint">—</span>
      </div>

      <!-- ===== GAUGE + RADAR (PRO) ===== -->
      <div class="layout2">
        <div class="leftPane">
          <div class="gaugeWrap">
            <svg id="scoreGauge" viewBox="0 0 200 120" class="gauge">
              <path id="gBg" d="M 20 100 A 80 80 0 0 1 180 100" class="gBg"></path>
              <path id="gFg" d="M 20 100 A 80 80 0 0 1 180 100" class="gFg"></path>

              <text id="gScore" x="100" y="78" text-anchor="middle" class="gScore">—</text>
              <text id="gLabel" x="100" y="98" text-anchor="middle" class="gLabel">Score</text>
            </svg>
          </div>
        </div>

        <div class="rightPane">
          <div class="radarHeader">
            <div class="radarTitle">RADAR</div>
            <div class="radarHint">Señal · Precio · EMA21</div>
          </div>
          <div id="radarList" class="radarList"></div>

          <!-- ===== BLOOMBERG STRUCTURE (EMA) ===== -->
<section class="bloomberg-structure">
  <div class="bb-head">
    <div class="bb-title">STRUCTURE</div>
    <div class="bb-sub" id="bbRegime">—</div>
  </div>

  <div class="bb-chart-wrap">
    <canvas id="emaCanvas" height="88"></canvas>
  </div>

  <div class="bb-meters">
    <div class="bb-meter">
      <div class="bb-meter-label">
        <span>EMA SPREAD</span>
        <span id="bbSpreadVal">—</span>
      </div>
      <div class="bb-bar">
        <div class="bb-bar-fill" id="bbSpreadFill"></div>
      </div>
      <div class="bb-meter-hint" id="bbSpreadHint">—</div>
    </div>

    <div class="bb-meter">
      <div class="bb-meter-label">
        <span>RISK (ATR%)</span>
        <span id="bbAtrVal">—</span>
      </div>
      <div class="bb-bar">
        <div class="bb-bar-fill" id="bbAtrFill"></div>
      </div>
      <div class="bb-meter-hint" id="bbAtrHint">—</div>
    </div>
  </div>

  <div class="bb-decision" id="bbDecision">
    <div class="bb-decision-mode" id="bbMode">—</div>
    <div class="bb-decision-line" id="bbLine1">—</div>
    <div class="bb-decision-line" id="bbLine2">—</div>
  </div>
</section>
          
        </div>
      </div>

    </div>
  </div>

  <script>
    let watchlistData = {};
    let macroData = { meta: {}, assets: {} };
    let currentAsset = null;

    let refreshTimer = null;
    let watchlistLoaded = false;
    let lastSignal = {}; // por símbolo

    const REFRESH_MS = 60000; // 60s
    const JSON_URL = "macro_data.json";
    const FREEZE_WARN_MS = 10 * 60_000; // 10 min

    let lastUpdatedISO = null;
    let lastUpdatedSeenAt = null;

    async function fetchJson(url) {
      const r = await fetch(url + "?v=" + Date.now());
      if (!r.ok) throw new Error(url + " HTTP " + r.status);
      return await r.json();
    }

    function setHealth(text, level = "good") {
      const el = document.getElementById("dataHealth");
      if (!el) return;
      el.textContent = text;
      el.classList.remove("good", "warn", "bad");
      el.classList.add(level);
    }

    function fmtAge(ms) {
      const s = Math.max(0, Math.floor(ms / 1000));
      const m = Math.floor(s / 60);
      const r = s % 60;
      return m <= 0 ? `${s}s` : `${m}m ${r}s`;
    }

    function parseUpdatedTs(macro) {
      const iso = macro?.meta?.updated_utc || macro?.meta?.updated || macro?.updated || null;
      if (!iso) return { iso: null, ts: null };
      const ts = Date.parse(iso);
      return { iso, ts: Number.isFinite(ts) ? ts : null };
    }

    /* =========================
       RADAR (GLOBAL ✅ ÚNICO)
       ========================= */
    function buildRadar() {
      const radar = document.getElementById("radarList");
      if (!radar) {
        console.warn("No existe #radarList en el DOM");
        return;
      }

      radar.innerHTML = "";

      // lista mínima segura (luego ampliamos)
      const symbols = ["GC=F", "BTC-USD"];

      symbols.forEach((sym) => {
        const data = macroData.assets?.[sym];
        if (!data) return;

        let color = "#94a3b8";
        if (data.signal === "explosion_up") color = "#22c55e";
        if (data.signal === "explosion_down") color = "#ef4444";

        const div = document.createElement("div");
        div.className = "radarItem";
        div.style.borderColor = color;

        div.innerHTML = `
          <div>
            <div class="radarSym">${sym}</div>
            <div class="radarMeta">${data.signal ?? "—"}</div>
          </div>

          <div></div>

          <div>
            <div class="radarPrice" style="color:${color}">${data.price ?? "—"}</div>
            <div class="radarEma">EMA21: ${data.ema21 ?? "—"}</div>
          </div>
        `;

        div.addEventListener("click", () => {
          currentAsset = sym;
          const sel = document.getElementById("assetSelect");
          if (sel) sel.value = sym;
          updateAssetView();
        });

        radar.appendChild(div);
      });
    }

    function buildSelector() {
      const select = document.getElementById("assetSelect");
      if (!select) return;

      select.innerHTML = "";

      for (const category in watchlistData) {
        const group = document.createElement("optgroup");
        group.label = category;

        (watchlistData[category] || []).forEach((asset) => {
          const option = document.createElement("option");
          option.value = asset.symbol;
          option.textContent = asset.name;
          group.appendChild(option);
        });

        select.appendChild(group);
      }

      select.addEventListener("change", () => {
        currentAsset = select.value;
        updateAssetView();
      });

      currentAsset = select.value;
    }

    function beep() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.connect(g); g.connect(ctx.destination);
        o.type = "sine";
        o.frequency.value = 880;
        g.gain.value = 0.05;
        o.start();
        setTimeout(() => { o.stop(); ctx.close(); }, 120);
      } catch (e) {}
    }

    async function loadData() {
      try {
        if (!watchlistLoaded) {
          watchlistData = await fetchJson("watchlist.json");
          watchlistLoaded = true;
          buildSelector();
        }

        macroData = await fetchJson(JSON_URL);

        const { iso, ts } = parseUpdatedTs(macroData);
        const now = Date.now();

        if (iso && ts) {
          const age = now - ts;

          let level = "good";
          if (age > 10 * 60_000) level = "bad";
          else if (age > 5 * 60_000) level = "warn";

          const frozen =
            lastUpdatedISO &&
            iso === lastUpdatedISO &&
            lastUpdatedSeenAt &&
            (now - lastUpdatedSeenAt) > FREEZE_WARN_MS;

          if (frozen) {
            setHealth(`⚠️ Datos congelados: updated=${iso} (edad ${fmtAge(age)}) | Fuente: ${JSON_URL}`, "bad");
          } else {
            setHealth(`✅ OK: updated=${iso} (edad ${fmtAge(age)}) | Fuente: ${JSON_URL}`, level);
          }

          if (iso !== lastUpdatedISO) {
            lastUpdatedISO = iso;
            lastUpdatedSeenAt = now;
          } else if (!lastUpdatedSeenAt) {
            lastUpdatedSeenAt = now;
          }
        } else {
          setHealth(`⚠️ No encuentro updated en JSON | Fuente: ${JSON_URL}`, "warn");
        }

        if (!macroData || typeof macroData !== "object") macroData = { meta: {}, assets: {} };
        if (!macroData.assets || typeof macroData.assets !== "object") macroData.assets = {};

        const sel = document.getElementById("assetSelect");
        if (!currentAsset && sel) currentAsset = sel.value;

        updateAssetView();
        buildRadar();

      } catch (err) {
        console.error(err);
        setHealth(`❌ Error cargando JSON | Fuente: ${JSON_URL}`, "bad");
        const title = document.getElementById("assetName");
        if (title) title.textContent = "ERROR: " + err.message;
      }
    }

    function updateAssetView() {
      const select = document.getElementById("assetSelect");
      const title  = document.getElementById("assetName");

      const uiTrend   = document.getElementById("uiTrend");
      const uiVol     = document.getElementById("uiVol");
      const uiSignal  = document.getElementById("uiSignal");
      const uiUpdated = document.getElementById("uiUpdated");

      const gScore = document.getElementById("gScore");
      const gFg    = document.getElementById("gFg");
      const sigDot = document.getElementById("sigDot");

      const uiStatePill = document.getElementById("uiStatePill");
      const uiStateText = document.getElementById("uiStateText");
      const uiStateHint = document.getElementById("uiStateHint");

      if (!select || !title) return;

      if (!currentAsset) currentAsset = select.value;
      if (select.value !== currentAsset) select.value = currentAsset;

      const assetName = select.selectedOptions?.[0]?.textContent || currentAsset || "Activo";
      title.textContent = assetName;

      const assetData = macroData.assets?.[currentAsset];
      console.log("ASSET", currentAsset, "score=", assetData?.score, "trend=", assetData?.trend, "sig=", assetData?.signal);

      const setState = (pillClass, pillText, text, hint) => {
        if (uiStatePill) {
          uiStatePill.className = `statePill ${pillClass}`;
          uiStatePill.textContent = pillText;
        }
        if (uiStateText) uiStateText.textContent = text;
        if (uiStateHint) uiStateHint.textContent = hint;
      };

      if (!assetData) {
        title.textContent += " (sin datos aún)";
        if (uiTrend) uiTrend.textContent = "—";
        if (uiVol) uiVol.textContent = "—";
        if (uiSignal) uiSignal.textContent = "—";
        if (uiUpdated) uiUpdated.textContent = macroData?.meta?.updated_utc || "—";

        if (sigDot) sigDot.className = "dot";
        if (gScore) gScore.textContent = "—";
        if (gFg) {
          gFg.style.stroke = "#94a3b8";
          gFg.style.strokeDashoffset = "251.2";
        }

        const mainCard = document.getElementById("mainCard");
        if (mainCard) mainCard.classList.remove("tone-up","tone-down");

        document.body.classList.remove("gauge-red","gauge-amber","gauge-green");

        setState("neutral", "ESTADO", "Sin datos", "Esperando actualización");
        return;
      }

      const trend = String(assetData.trend ?? "—");
      const vol   = String(assetData.volatility ?? "—");
      const sig   = String(assetData.signal ?? "—");

      const mainCard = document.getElementById("mainCard");
      if (mainCard){
        mainCard.classList.remove("tone-up","tone-down");
        if (sig === "explosion_up") mainCard.classList.add("tone-up");
        if (sig === "explosion_down") mainCard.classList.add("tone-down");
      }

      const prevSig = lastSignal[currentAsset];
      if (prevSig && prevSig !== sig) {
        console.log(`[ALERTA] ${currentAsset}: ${prevSig} -> ${sig}`);
        beep();
        if (sig === "explosion_up") showToast(`${assetName} – EXPLOSION UP`, "up");
        if (sig === "explosion_down") showToast(`${assetName} – EXPLOSION DOWN`, "down");
      }
      lastSignal[currentAsset] = sig;

      // chips
      const bSig = document.getElementById("badgeSignal");
      const bTr  = document.getElementById("badgeTrend");
      const bVol = document.getElementById("badgeVol");

      function paint(el, color){
        if (!el) return;
        el.style.borderColor = color;
        el.style.color = color;
      }

      if (sig === "explosion_up") paint(bSig, "#22c55e");
      else if (sig === "explosion_down") paint(bSig, "#ef4444");
      else paint(bSig, "#94a3b8");

      if (trend.toLowerCase() === "bullish") paint(bTr, "#22c55e");
      else if (trend.toLowerCase() === "bearish") paint(bTr, "#ef4444");
      else paint(bTr, "#94a3b8");

      if (vol.toLowerCase() === "low") paint(bVol, "#22c55e");
      else if (vol.toLowerCase() === "high") paint(bVol, "#f59e0b");
      else paint(bVol, "#94a3b8");

      if (uiTrend) uiTrend.textContent = trend;
      if (uiVol) uiVol.textContent = vol;
      if (uiSignal) uiSignal.textContent = sig;
      if (uiUpdated) uiUpdated.textContent = macroData?.meta?.updated_utc || "—";

      // gauge
      const score = Number(assetData.score ?? 0);
      const clamped = Math.max(0, Math.min(100, score));

      document.body.classList.remove("gauge-red","gauge-amber","gauge-green");
      if (clamped < 40) document.body.classList.add("gauge-red");
      else if (clamped <= 70) document.body.classList.add("gauge-amber");
      else document.body.classList.add("gauge-green");

      if (gScore) {
        gScore.textContent = String(clamped);
        if (clamped < 40) gScore.style.fill = "#ef4444";
        else if (clamped <= 70) gScore.style.fill = "#f59e0b";
        else gScore.style.fill = "#22c55e";
      }

      const total = 251.2;
      const offset = total * (1 - clamped / 100);

      let color = "#94a3b8";
      if (clamped < 40) color = "#ef4444";
      else if (clamped <= 70) color = "#f59e0b";
      else color = "#22c55e";

      if (gFg) {
        gFg.style.stroke = color;
        gFg.style.strokeDasharray = String(total);
        gFg.style.strokeDashoffset = String(offset);
      }

      if (sigDot) {
        sigDot.className = "dot";
        if (sig === "explosion_up") sigDot.classList.add("up");
        if (sig === "explosion_down") sigDot.classList.add("down");
      }

      // Market state
      const volLow = (vol.toLowerCase() === "low");
      const bullish = (trend.toLowerCase() === "bullish");
      const bearish = (trend.toLowerCase() === "bearish");

      if (clamped >= 75 && bullish && sig === "explosion_up") {
        setState("up", "MOMENTUM", "Impulso fuerte", "Probable continuación (ojo pullbacks)");
      } else if (sig === "explosion_down" || clamped <= 35) {
        setState("down", "RIESGO", "Presión bajista", "Evitar FOMO / buscar confirmación");
      } else if (volLow && clamped >= 40 && clamped <= 70) {
        setState("neutral", "COMPR.", "Compresión", "Posible salida en breve (esperar señal)");
      } else if (bearish && clamped < 55) {
        setState("down", "BAJISTA", "Sesgo bajista", "Rebotes = posible venta");
      } else {
        setState("neutral", "NEUTRAL", "Mercado mixto", "Esperar mejor ventana");
      }
      
              // ===== BLOOMBERG STRUCTURE (EMA) =====
      try {
        // Copia limpia del asset actual
        const asset = { ...assetData };

        // Tu atr_pct viene en decimal (0.004 = 0.4%) -> convertir a %
        if (asset.atr_pct != null) {
          const v = Number(asset.atr_pct);
          asset.atr_pct = (Number.isFinite(v) && v < 1) ? (v * 100) : v;
        }

        // Si falta ema50, no rompemos (fallback)
        if (asset.ema50 == null) asset.ema50 = asset.ema21;

       // series viene del JSON: premium_out.series
    const sym = currentSymbol; // o como lo llames tú (selectedSymbol)
    const series = (data && data.series && data.series[sym]) ? data.series[sym] : null;

    renderBloombergStructure(asset, series);
        
      } catch (e) {
        console.warn("Bloomberg Structure error:", e);
      } 
    }

    function startAutoRefresh() {
      if (refreshTimer) clearInterval(refreshTimer);
      refreshTimer = setInterval(loadData, REFRESH_MS);
    }

    function showToast(message, type){
      const t = document.createElement("div");
      t.className = `toast ${type}`;
      t.textContent = message;
      document.body.appendChild(t);

      setTimeout(() => t.classList.add("show"), 50);

      setTimeout(() => {
        t.classList.remove("show");
        setTimeout(() => t.remove(), 300);
      }, 4000);
    }

    document.addEventListener("DOMContentLoaded", () => {
  loadData();
  startAutoRefresh();

  const rb = document.getElementById("refreshBtn");
  if (rb) rb.addEventListener("click", loadData);
});

    function pct(n){ return (n*100).toFixed(2) + "%"; }
function clamp01(x){ return Math.max(0, Math.min(1, x)); }

// Clasificador de régimen Bloomberg-style
function calcRegime({signal, score, ema21, ema50, atr_pct, spread_pct}) {
  const trendBull = ema21 > ema50;
  const highScore = score >= 75;
  const medScore  = score >= 60 && score < 75;

  const lowVol = atr_pct !== null && atr_pct <= 0.7;
  const highVol = atr_pct !== null && atr_pct >= 1.2;

  const compression = spread_pct !== null && spread_pct < 0.15; // % muy pegadas
  const healthyExp  = spread_pct !== null && spread_pct >= 0.15 && spread_pct <= 0.80;
  const extended    = spread_pct !== null && spread_pct > 0.80;

  // Decisión base
  if (highScore && !highVol && healthyExp && (signal === "explosion_up" || signal === "explosion_down")) {
    return { mode: "MODO ATAQUE", sub: trendBull ? "Bull Expansion" : "Bear Expansion" };
  }
  if (compression && (medScore || highScore)) {
    return { mode: "MODO VIGILANCIA", sub: "Compression / Pre-break" };
  }
  if (highVol || extended) {
    return { mode: "MODO DEFENSA", sub: "High Risk / Extended" };
  }
  return { mode: "MODO ESPERA", sub: "No Edge" };
}

function setBar(el, value01, tone){
  el.style.width = (value01*100).toFixed(0) + "%";
  // tono: "green"|"yellow"|"red"
  if (tone==="green") el.style.background = "rgba(130,255,180,.78)";
  if (tone==="yellow") el.style.background = "rgba(255,210,120,.78)";
  if (tone==="red") el.style.background = "rgba(255,120,140,.78)";
}

function renderBloombergStructure(asset, series){
  // asset: {price, ema21, ema50, atr_pct, score, signal}
  // series: {price:[], ema21:[], ema50:[]} (si no tienes serie, igual pintamos 1 punto con fallback)

  const price = Number(asset.price);
  const ema21 = Number(asset.ema21);
  const ema50 = Number(asset.ema50);

  const atrPct = asset.atr_pct==null ? null : Number(asset.atr_pct); // ya viene convertido a % desde updateAssetView
  const score  = asset.score==null ? 0 : Number(asset.score);
  const signal = asset.signal || "neutral";

  // spread % respecto al precio
  const spreadPct = (Number.isFinite(price) && price!==0) ? (Math.abs(ema21-ema50)/price)*100 : null;

  // Regime
  const reg = calcRegime({
    signal, score, ema21, ema50,
    atr_pct: atrPct,
    spread_pct: spreadPct
  });

  document.getElementById("bbRegime").textContent = reg.sub;

  // Medidor Spread: escala 0 → 1.2%
  const spreadNorm = spreadPct==null ? 0 : clamp01(spreadPct/1.2);
  document.getElementById("bbSpreadVal").textContent = spreadPct==null ? "—" : spreadPct.toFixed(2) + "%";

  let spreadTone = "green";
  let spreadHint = "Expansión saludable";
  if (spreadPct != null && spreadPct < 0.15){ spreadTone="yellow"; spreadHint="Compresión: posible ruptura"; }
  if (spreadPct != null && spreadPct > 0.80){ spreadTone="red"; spreadHint="Extendido: riesgo de pullback"; }

  setBar(document.getElementById("bbSpreadFill"), spreadNorm, spreadTone);
  document.getElementById("bbSpreadHint").textContent = spreadHint;

  // Medidor ATR%: escala 0 → 2.0%
  const atrNorm = atrPct==null ? 0 : clamp01(atrPct/2.0);
  document.getElementById("bbAtrVal").textContent = atrPct==null ? "—" : atrPct.toFixed(2) + "%";

  let atrTone = "green";
  let atrHint = "Riesgo bajo/normal";
  if (atrPct != null && atrPct > 0.9){ atrTone="yellow"; atrHint="Riesgo medio: cuidado entradas tarde"; }
  if (atrPct != null && atrPct > 1.3){ atrTone="red"; atrHint="Riesgo alto: evita mercado sucio"; }

  setBar(document.getElementById("bbAtrFill"), atrNorm, atrTone);
  document.getElementById("bbAtrHint").textContent = atrHint;

  // Decisión grande (texto)
  const modeEl = document.getElementById("bbMode");
  const l1 = document.getElementById("bbLine1");
  const l2 = document.getElementById("bbLine2");

  modeEl.textContent = reg.mode;

  // Color por modo
  const box = document.getElementById("bbDecision");
  if (reg.mode==="MODO ATAQUE"){ box.style.borderColor="rgba(130,255,180,.30)"; }
  if (reg.mode==="MODO VIGILANCIA"){ box.style.borderColor="rgba(255,210,120,.30)"; }
  if (reg.mode==="MODO DEFENSA"){ box.style.borderColor="rgba(255,120,140,.30)"; }
  if (reg.mode==="MODO ESPERA"){ box.style.borderColor="rgba(180,180,255,.22)"; }

  const trendTxt = (ema21>ema50) ? "EMA21 > EMA50 (Bull)" : "EMA21 < EMA50 (Bear)";
  l1.textContent = `${trendTxt} | Señal: ${signal.toUpperCase()} | Score: ${score.toFixed(0)}`;
  l2.textContent = (reg.mode==="MODO ATAQUE")
    ? "Plan: buscar entrada en retroceso/control (no perseguir vela)."
    : (reg.mode==="MODO VIGILANCIA")
      ? "Plan: esperar confirmación (ruptura + cierre) antes de actuar."
      : (reg.mode==="MODO DEFENSA")
        ? "Plan: reducir riesgo, evitar entradas impulsivas, esperar limpieza."
        : "Plan: no hay ventaja; conservar munición.";

  // Mini chart (canvas): price + EMA21 + EMA50
  drawEmaCanvas("emaCanvas", series, { price, ema21, ema50 });
}

// Dibujo canvas sencillo (no depende de librerías)
function drawEmaCanvas(canvasId, series, last){
  const c = document.getElementById(canvasId);
  if (!c) return;
  const ctx = c.getContext("2d");
  const w = c.width = c.parentElement.clientWidth - 2;
  const h = c.height;

  // Fondo
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle = "rgba(0,0,0,.08)";
  ctx.fillRect(0,0,w,h);

  const p = (series && series.price && series.price.length) ? series.price : [last.price];
  const e21 = (series && series.ema21 && series.ema21.length) ? series.ema21 : [last.ema21];
  const e50 = (series && series.ema50 && series.ema50.length) ? series.ema50 : [last.ema50];

  const n = Math.max(p.length, e21.length, e50.length);
  const get = (arr,i)=> arr[Math.min(arr.length-1,i)];

  // rango
  let min=Infinity,max=-Infinity;
  for(let i=0;i<n;i++){
    const a=[get(p,i),get(e21,i),get(e50,i)];
    a.forEach(v=>{ min=Math.min(min,v); max=Math.max(max,v); });
  }
  if (!Number.isFinite(min) || !Number.isFinite(max) || min===max){ min-=1; max+=1; }

  const X = i => (i/(n-1||1))*(w-16)+8;
  const Y = v => (h-10) - ((v-min)/(max-min))*(h-20);

  // banda entre EMAs (sombra institucional)
  ctx.beginPath();
  for(let i=0;i<n;i++){
    const x=X(i), y=Y(get(e21,i));
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  for(let i=n-1;i>=0;i--){
    const x=X(i), y=Y(get(e50,i));
    ctx.lineTo(x,y);
  }
  ctx.closePath();
  ctx.fillStyle = (last.ema21>last.ema50) ? "rgba(130,255,180,.10)" : "rgba(255,120,140,.10)";
  ctx.fill();

  // ema21
  ctx.beginPath();
  for(let i=0;i<n;i++){
    const x=X(i), y=Y(get(e21,i));
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.strokeStyle = "rgba(130,255,180,.65)";
  ctx.lineWidth = 2;
  ctx.stroke();

  // ema50
  ctx.beginPath();
  for(let i=0;i<n;i++){
    const x=X(i), y=Y(get(e50,i));
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.strokeStyle = "rgba(180,180,255,.55)";
  ctx.lineWidth = 2;
  ctx.stroke();

  // precio
  ctx.beginPath();
  for(let i=0;i<n;i++){
    const x=X(i), y=Y(get(p,i));
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.strokeStyle = "rgba(255,255,255,.55)";
  ctx.lineWidth = 1.5;
  ctx.stroke();

  // último punto
  ctx.beginPath();
  ctx.arc(X(n-1), Y(get(p,n-1)), 2.6, 0, Math.PI*2);
  ctx.fillStyle = "rgba(255,255,255,.85)";
  ctx.fill();
}
  </script>
</body>
</html>
